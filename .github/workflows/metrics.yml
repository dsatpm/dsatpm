name: GitHub Metrics

# Ensure only one run at a time; cancel any in-progress run when a new one starts
concurrency:
    group: github-metrics
    cancel-in-progress: true

on:
    # Schedule daily updates
    schedule:
        - cron: "0 0 * * *"
    # Manual trigger
    workflow_dispatch:
    # Limit push-trigger to workflow edits to avoid commit loops from metrics updates
    push:
        branches: ["main"]
        paths:
            - ".github/workflows/metrics.yml"

jobs:
    github-metrics:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        permissions:
            contents: write # Needed to write the SVG files
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            # Header-only card
            - name: Generate header metrics card
              uses: lowlighter/metrics@v3
              with:
                  token: ${{ secrets.METRICS_TOKEN }}
                  filename: metrics.plugin.header.svg
                  output_action: none
                  config_presets: dracula
                  base: header, metadata
                  config_display: regular
                  config_timezone: America/Los_Angeles

            # Isocalendar card
            - name: Generate isocalendar metrics card
              uses: lowlighter/metrics@v3
              with:
                  token: ${{ secrets.METRICS_TOKEN }}
                  filename: metrics.plugin.isocalendar.svg
                  output_action: none
                  config_presets: dracula
                  base: ""
                  plugin_isocalendar: yes
                  plugin_isocalendar_duration: full-year
                  config_timezone: America/Los_Angeles

            # Languages card
            - name: Generate languages metrics card
              uses: lowlighter/metrics@v3
              with:
                  token: ${{ secrets.METRICS_TOKEN }}
                  filename: metrics.plugin.languages.svg
                  output_action: none
                  config_presets: dracula
                  base: ""
                  plugin_languages: yes
                  plugin_languages_details: bytes-size, percentage
                  plugin_languages_threshold: 0%
                  plugin_languages_colors: github
                  plugin_languages_limit: 8
                  config_timezone: America/Los_Angeles

            # Habits card
            - name: Generate habits metrics card
              uses: lowlighter/metrics@v3
              with:
                  token: ${{ secrets.METRICS_TOKEN }}
                  filename: metrics.plugin.habits.svg
                  output_action: none
                  config_presets: dracula
                  base: ""
                  plugin_habits: yes
                  plugin_habits_from: 200
                  plugin_habits_charts: yes
                  plugin_habits_days: 14
                  plugin_habits_facts: yes
                  config_timezone: America/Los_Angeles

            # Achievements card
            - name: Generate achievements metrics card
              uses: lowlighter/metrics@v3
              with:
                  token: ${{ secrets.METRICS_TOKEN }}
                  filename: metrics.plugin.achievements.svg
                  output_action: none
                  config_presets: dracula
                  base: ""
                  plugin_achievements: yes
                  plugin_achievements_threshold: C
                  plugin_achievements_limit: 0
                  config_timezone: America/Los_Angeles

            # Commit all generated images in a single commit
            - name: Commit metrics images
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "chore(metrics): update GitHub metrics [skip ci]"
                  branch: main
                  file_pattern: metrics*.svg
